stages:
  - test
  - build

run_tests:
  stage: test
  script:
    - AT_WTIOIT_PYCHARM_PLUGIN_testVersion=$VERSION AT_WTIOIT_PYCHARM_PLUGIN_testType=$TYPE ./gradlew test
  after_script:
    - java -version
  parallel:
    matrix:
      - TYPE: "PC" # PyCharm Community
        # TODO find a way to test "2019.2", "2019.3", "2020.1", "2020.2" with compiled plugin
        # we should still be run-time compatible, but are not compile-time compatible
        VERSION: [ "2020.3", "2021.1", "2021.2", "2021.3", "2022.1", "2022.1.1" ]
      - TYPE: "PY" # PyCharm Professional
        VERSION: [ "2020.3", "2021.1", "2021.2", "2021.3", "2022.1", "2022.1.1" ]
  artifacts:
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/reports
    when: always

verify_plugin:
  stage: test
  script:
    - ./gradlew verifyPlugin
  after_script:
    - java -version

plugin_verifier:
  stage: test
  script:
    - ./gradlew runPluginVerifier
  after_script:
    - java -version
  artifacts:
    paths:
      - build/reports/pluginVerifier/
    when: always

build:
  stage: build
  script:
    - ./gradlew buildPlugin
  artifacts:
    paths:
      - build/libs/odoo_plugin-*.jar
      - "build/distributions/Odoo Autocompletion Support-*.jar"